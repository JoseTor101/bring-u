{% extends 'base.html' %}
{% block content %}


<style>
    body {
        margin: 0; /* Remove margin to avoid unexpected scrolling behavior */
        padding: 0; /* Remove padding to avoid unexpected scrolling behavior */
    }
    .chat-container {
        height: auto; /* Adjust the maximum height as needed */
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* Align messages to the bottom (right-aligned sent messages) */
    }
    .messages {
        border-radius: 10px;
        padding: 10px;
        margin: 10px;
        max-width: 70%; /* Adjust as needed */
    }
    .messages-sent {
        background-color: #cfe2ff; /* Example background color for sent messages */
        align-self: flex-end;
    }
    .messages-received {
        background-color: #f0f0f0; /* Example background color for received messages */
        align-self: flex-start;
    }
    .message-sender {
        font-weight: bold;
    }
    .message-input-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: #f0f0f0; /* Background color for the input container */
    }
    .message-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        margin-right: 10px;
    }
    .send-button {
        background-color: #007bff; /* Example background color for the send button */
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>

<body>
    <h1 id="title" data-chat-id="{{ chatId }}">Conversacion {{ chat.id_chat }}</h1>
    <span id="user" data-user="{{ user }}"></span>
    <div class="chat-container" id="chat-container">
        {% for message in messages %}
        <div class="messages {% if message.sender == user %}messages-sent{% else %}messages-received{% endif %}" data-sender="{{ message.sender }}">
            <span class="message-sender">{{ message.sender }}</span>
            <p>{{ message.content }}</p>
            <p>{{ message.timestamp }}</p>
        </div>
        {% endfor %}
    </div>

    <!--<div class="message-input-container">
        <form id="message-form" method="POST">
            {% csrf_token %}
            <textarea id="message" name="content" placeholder="Type your message..."></textarea>
            <button type="submit" id="send-button" >Send</button>
        </form>
    </div>-->
    <div class="message-container">
        <textarea id="message" name="content" placeholder="Type your message..."></textarea>
        <button type="submit" id="send-button" >Send</button>
    </div>

<script>
    const id_chat = "{{ chatId }}"
    const chatSocket = new WebSocket(`wss://${window.location.host}/ws/chat/${id_chat}/`);
    const user = "{{ request.user.username }}"  
    
    console.log(chatSocket);

    chatSocket.onopen = function (e) {
        console.log("The connection was set up successfully!");
    };

    chatSocket.onclose = function (e) {
    console.log("The connection was closed!");
    };

    document.querySelector("#message").focus();

    document.querySelector("#message").onkeyup = function (e) {
    if (e.keyCode == 13) {
        document.querySelector("#send-button").click();
    }
    };

    document.querySelector("#send-button").onclick = function (e) {
    // Check if the WebSocket is open before sending a message.
    if (chatSocket.readyState === WebSocket.OPEN) {
        var messageInput = document.querySelector("#message").value;
        chatSocket.send(
        JSON.stringify({
            username: user,
            message: messageInput,
            chat_id: "{{ chatId }}"
        })
        );
    } else {
        console.log("WebSocket is not in the OPEN state.");
    }
    };

    chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    var messageClass = data.user === user ? "messages-sent" : "messages-received";
    var messageElement = document.createElement("div");
    messageElement.className = `messages ${messageClass}`;
    messageElement.innerHTML = `
        <span class="message-sender">${data.username}</span>
        <p>${data.message}</p>
    `;
    document.querySelector("#send-button").value = "";
    chatContainer.appendChild(messageElement);
    };

</script>

<!--<script>
<script>
    var user = "{{ request.user.username }}";
    var chatId = "{{ chat.id_chat }}";
    const chatContainer = document.querySelector(".chat-container");
    const messageInput = document.getElementById('message');
    const sendMessage = document.getElementById('send-button');

    const chatSocket = new WebSocket(
        'wss://' + window.location.host +`/ws/chat/${chatId}/`);

    // Event listener for form submission
    sendMessage.addEventListener('click', function (e) {
        e.preventDefault();
        const message = messageInput.value;
        
        // Check if the WebSocket is in the OPEN state before sending
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'username': user,
            }));
            messageInput.value = '';
        } else {
            console.error('WebSocket connection is not open.');
        }
    });

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const messageClass = data.user === user ? 'messages-sent' : 'messages-received';
        const messageElement = document.createElement('div');
        messageElement.className = `messages ${messageClass}`;
        messageElement.innerHTML = `
            <span class="message-sender">${data.user}</span>
            <p>${data.message}</p>
        `;
        chatContainer.appendChild(messageElement);
    };
</script>
    <script>
        var currentUrl = window.location;
        var user = document.getElementById('user').getAttribute('data-user');
        var chatContainer = $(".chat-container");
        var chatId = document.getElementById('title').getAttribute('data-chat-id');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message');  

        const chatSocket = new WebSocket(
            'wss://' +
            window.location.host +
            '/ws/chat/' +
            chatId +  // Replace with the variable that holds the chat_id
            '/'
        );
        
        
        chatSocket.onopen = function (event) {
            // WebSocket is open and ready to send messages
            messageForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const message = messageInput.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': "{{request.user.username}}",
                }));
                messageInput.value = '';
            });
        };
        

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const messageClass = data.user === user_user ? 'messages-sent' : 'messages-received';
            const messageElement = document.createElement('div');
            messageElement.className = `messages ${messageClass}`;
            messageElement.innerHTML = `
                <span class="message-sender">${data.user}</span>
                <p>${data.message}</p>
            `;
            chatContainer.appendChild(messageElement);
        };
      
    </script>-->

   
</body>
</html>
{% endblock content %}
